name: Bump Version

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: Select which part of the version to increment.
        type: choice
        options:
          - major
          - minor
          - patch
        default: patch

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        id: bump
        run: |
          VERSION_FILE="version.txt"
          if [ ! -f "$VERSION_FILE" ]; then
            echo "version.txt not found" >&2
            exit 1
          fi

          CURRENT_VERSION=$(cat "$VERSION_FILE")
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          case "${{ github.event.inputs.release_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
            *)
              echo "Unknown release type: ${{ github.event.inputs.release_type }}" >&2
              exit 1
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "$NEW_VERSION" > "$VERSION_FILE"

          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Commit and push
        env:
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
          BRANCH_REF: ${{ github.ref }}
        run: |
          if git diff --quiet; then
            echo "No version change detected."
            exit 0
          fi

          git add version.txt
          git commit -m "Bump version to ${NEW_VERSION}"
          git tag "v${NEW_VERSION}"
          BRANCH_NAME="${BRANCH_REF#refs/heads/}"
          if [ -z "$BRANCH_NAME" ]; then
            echo "Unable to determine target branch from ref: $BRANCH_REF" >&2
            exit 1
          fi

          git push origin HEAD:refs/heads/"$BRANCH_NAME"
          git push origin "v${NEW_VERSION}"
